<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Analyseur de sondage PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 40px;
        }

        h1 {
            text-align: center;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

        .block {
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            font-size: 14px;
        }

        input[type="file"] {
            margin-top: 10px;
        }

        button {
            background: #007bff;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

            button:hover {
                background: #0056b3;
            }

        .results {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            text-align: center;
        }

        .card {
            background: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            width: 28%;
        }

            .card h2 {
                margin: 0;
            }
    </style>
</head>
<body>

    <div class="container">
        <h1>Analyse de sondage ‚Äì Maisons closes</h1>

        <div class="block">
            <h3>1Ô∏è‚É£ Importer le fichier PDF</h3>
            <input type="file" id="pdfInput" accept="application/pdf" />
        </div>

        <div class="block">
            <h3>2Ô∏è‚É£ Mots-cl√©s POUR</h3>
            <textarea id="pourKeywords"></textarea>
        </div>

        <div class="block">
            <h3>3Ô∏è‚É£ Mots-cl√©s CONTRE</h3>
            <textarea id="contreKeywords"></textarea>
        </div>

        <div class="block">
            <button onclick="analyze()">üìä Lancer l‚Äôanalyse</button>
            <button onclick="resetKeywords()">üîÑ R√©initialiser mots-cl√©s</button>
        </div>

        <div class="results">
            <div class="card">
                <h2>‚úÖ POUR</h2>
                <p id="pourResult">0 %</p>
            </div>
            <div class="card">
                <h2>‚ùå CONTRE</h2>
                <p id="contreResult">0 %</p>
            </div>
            <div class="card">
                <h2>‚öñÔ∏è NEUTRE</h2>
                <p id="neutralResult">0 %</p>
            </div>
        </div>
    </div>

    <script>
        /* ===========================
           Mots-cl√©s par d√©faut
        =========================== */
        let defaultKeywords = {
            pour: [
    "je suis pour",
    "pour",
    "favorable",
    "bonne id√©e",
    "excellente",
    "tr√®s bonne",
    "oui",
    "d'accord",
    "totalement pour",
    "100% pour",
    "n√©cessaire",
    "souhaitable",
    "bonne chose",
    "tr√®s favorable"
  ],
  contre: [
    "contre",
    "mauvaise id√©e",
    "jamais",
    "honte",
    "esclavage",
    "lamentable",
    "inadmissible",
    "r√©gression",
    "pas d'accord",
    "folie",
    "erreur"
  ]
        };

        let keywords = { ...defaultKeywords };

        // Charger depuis localStorage si disponible
        const saved = localStorage.getItem("keywords");
        if (saved) {
            const local = JSON.parse(saved);
            if (local.pour) keywords.pour = local.pour.split("\n").filter(Boolean);
            if (local.contre) keywords.contre = local.contre.split("\n").filter(Boolean);
        }

        // Remplir les textarea
        document.getElementById("pourKeywords").value = keywords.pour.join("\n");
        document.getElementById("contreKeywords").value = keywords.contre.join("\n");

        // === Sauvegarde dans localStorage ===
        function saveKeywords() {
            const pour = document.getElementById("pourKeywords").value.split("\n").map(s => s.trim()).filter(Boolean);
            const contre = document.getElementById("contreKeywords").value.split("\n").map(s => s.trim()).filter(Boolean);
            localStorage.setItem("keywords", JSON.stringify({ pour: pour.join("\n"), contre: contre.join("\n") }));
        }

        // === R√©initialiser mots-cl√©s ===
        function resetKeywords() {
            keywords = { ...defaultKeywords };
            document.getElementById("pourKeywords").value = keywords.pour.join("\n");
            document.getElementById("contreKeywords").value = keywords.contre.join("\n");
            localStorage.removeItem("keywords");
            alert("Mots-cl√©s r√©initialis√©s !");
        }

        // === Normalisation Unicode pour g√©rer accents ===
        function normalizeText(text) {
    return text
        .normalize("NFD")                     // d√©compose les accents
        .replace(/[\u0300-\u036f]/g, "")      // supprime les diacritiques
        .replace(/[‚Äô‚Äò`]/g, "'")               // unifie toutes les apostrophes
        .replace(/[‚Äú‚Äù¬´¬ª]/g, '"')              // unifie les guillemets
        .replace(/[\u2013\u2014]/g, "-")      // tirets sp√©ciaux
        .replace(/[^\w\s'-]/g, "")            // supprime autres caract√®res non alphanum√©riques sauf espace, ' et -
        .toLowerCase();                        // minuscule
}

        // === Extraction PDF ===
        async function extractTextFromPDF(file) {
            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                content.items.forEach(item => text += item.str + " ");
            }
            return normalizeText(text);
        }

        // === Score pond√©r√© ===
        function scoreText(text, keywords) {
            let score = 0;
            keywords.forEach(k => {
                if (!k) return;
                const kw = normalizeText(k);
                const exact = new RegExp(`\\b${kw}\\b`, "gi");
                const exactMatches = text.match(exact);
                if (exactMatches) score += exactMatches.length * 2; // mot exact = 2 pts
                if (text.includes(kw)) score += 1;               // mot partiel = 1 pt
            });
            return score;
        }

        // === Classification ===
        function classify(text, pour, contre) {
            const scorePour = scoreText(text, pour);
            const scoreContre = scoreText(text, contre);
            if (scorePour > scoreContre) return "pour";
            if (scoreContre > scorePour) return "contre";
            return "neutre";
        }

        // === Analyse ===
        async function analyze() {
            saveKeywords(); // sauvegarde avant analyse
            const file = document.getElementById("pdfInput").files[0];
            if (!file) return alert("Veuillez s√©lectionner un PDF");

            const pour = document.getElementById("pourKeywords").value.split("\n").map(s => normalizeText(s)).filter(Boolean);
            const contre = document.getElementById("contreKeywords").value.split("\n").map(s => normalizeText(s)).filter(Boolean);

            const text = await extractTextFromPDF(file);

            const opinions = text.split(/[.!?]\s+/);
            let results = { pour: 0, contre: 0, neutre: 0 };

            opinions.forEach(op => {
                if (op.trim().length > 40) {
                    const cat = classify(op, pour, contre);
                    results[cat]++;
                }
            });

            const total = results.pour + results.contre + results.neutre;
            if (total === 0) return alert("Aucune opinion d√©tect√©e");

            document.getElementById("pourResult").innerText = ((results.pour / total) * 100).toFixed(1) + " %";
            document.getElementById("contreResult").innerText = ((results.contre / total) * 100).toFixed(1) + " %";
            document.getElementById("neutralResult").innerText = ((results.neutre / total) * 100).toFixed(1) + " %";
        }
    </script>

</body>
</html>

