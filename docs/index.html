<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Analyseur de sondage PDF</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 40px;
        }
        h1, h2 { text-align: center; }

        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

        .block { margin-bottom: 25px; }

        textarea {
            width: 100%;
            height: 90px;
            padding: 10px;
        }

        button {
            background: #007bff;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover { background: #0056b3; }

        .results {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
        }

        .card {
            background: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            width: 22%;
            text-align: center;
        }

        canvas {
            max-width: 400px;
            margin: 30px auto;
            display: block;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Analyse de sondage ‚Äì Maisons closes</h1>

    <div class="block">
        <h3>1Ô∏è‚É£ Importer le fichier PDF</h3>
        <input type="file" id="pdfInput" accept="application/pdf" />
    </div>

    <div class="block">
        <h3>2Ô∏è‚É£ Mots-cl√©s POUR</h3>
        <textarea id="pourKeywords"></textarea>
    </div>

    <div class="block">
        <h3>3Ô∏è‚É£ Mots-cl√©s POUR SOUS CONDITIONS</h3>
        <textarea id="conditionalKeywords"></textarea>
    </div>

    <div class="block">
        <h3>4Ô∏è‚É£ Mots-cl√©s CONTRE</h3>
        <textarea id="contreKeywords"></textarea>
    </div>

    <div class="block">
        <button onclick="analyze()">üìä Lancer l‚Äôanalyse</button>
        <button onclick="resetKeywords()">üîÑ R√©initialiser</button>
    </div>

    <h2>üë• Personnes analys√©es : <span id="count">0</span></h2>

    <div class="results">
        <div class="card"><h3>‚úÖ POUR</h3><p id="pourResult">0 %</p></div>
        <div class="card"><h3>üü¶ POUR (conditions)</h3><p id="conditionalResult">0 %</p></div>
        <div class="card"><h3>‚ùå CONTRE</h3><p id="contreResult">0 %</p></div>
        <div class="card"><h3>‚öñÔ∏è NEUTRE</h3><p id="neutralResult">0 %</p></div>
    </div>

    <canvas id="chart"></canvas>
</div>

<script>
/* =========================
   MOTS-CL√âS
========================= */
const defaultKeywords = {
    pour: [
        "je suis pour",
        "totalement pour",
        "favorable",
        "tres favorable",
        "bonne idee",
        "excellente idee"
    ],
    conditional: [
        "a condition",
        "sous condition",
        "mais",
        "si"
    ],
    contre: [
        "contre",
        "mauvaise idee",
        "jamais",
        "honte",
        "esclavage",
        "inadmissible",
        "regression"
    ]
};

let keywords = JSON.parse(localStorage.getItem("keywords")) || defaultKeywords;
pourKeywords.value = keywords.pour.join("\n");
conditionalKeywords.value = keywords.conditional.join("\n");
contreKeywords.value = keywords.contre.join("\n");

/* =========================
   UTILS
========================= */
function normalizeText(text) {
    return text.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[‚Äô‚Äò`]/g, "'")
        .replace(/[^\w\s'-]/g, "")
        .toLowerCase();
}

/* =========================
   PDF EXTRACTION
========================= */
async function extractTextFromPDF(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        content.items.forEach(item => text += item.str + " ");
    }

    // üî• lib√©ration explicite
    pdf.cleanup();
    pdf.destroy();

    return normalizeText(text);
}

/* =========================
   SCORING
========================= */
function scoreText(text, list) {
    let score = 0;
    list.forEach(k => {
        const kw = normalizeText(k);
        const regex = new RegExp(`\\b${kw}\\b`, "g");
        const matches = text.match(regex);
        if (matches) score += matches.length;
    });
    return score;
}

/* =========================
   CLASSIFICATION
========================= */
function classify(text) {
    const p = scoreText(text, keywords.pour);
    const c = scoreText(text, keywords.conditional);
    const n = scoreText(text, keywords.contre);

    if (n > 0 && n >= p) return "contre";
    if (p > 0 && c > 0) return "conditional";
    if (p > 0) return "pour";
    return "neutre";
}

/* =========================
   ANALYSE
========================= */
let chartInstance = null;

async function analyze() {
    const input = document.getElementById("pdfInput");
    const file = input.files[0];
    if (!file) return alert("S√©lectionne un PDF");

    keywords = {
        pour: pourKeywords.value.split("\n").map(normalizeText).filter(Boolean),
        conditional: conditionalKeywords.value.split("\n").map(normalizeText).filter(Boolean),
        contre: contreKeywords.value.split("\n").map(normalizeText).filter(Boolean)
    };
    localStorage.setItem("keywords", JSON.stringify(keywords));

    const text = await extractTextFromPDF(file);
    const opinions = text.split(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/);

    let results = { pour: 0, conditional: 0, contre: 0, neutre: 0 };
    opinions.forEach(op => {
        if (op.trim().length > 10) {
            results[classify(op)]++;
        }
    });

    const total = Object.values(results).reduce((a,b)=>a+b,0);
    count.innerText = total;

    pourResult.innerText = ((results.pour/total)*100).toFixed(1)+" %";
    conditionalResult.innerText = ((results.conditional/total)*100).toFixed(1)+" %";
    contreResult.innerText = ((results.contre/total)*100).toFixed(1)+" %";
    neutralResult.innerText = ((results.neutre/total)*100).toFixed(1)+" %";

    renderChart(results);

    // üßπ NETTOYAGE FINAL
    input.value = "";           // supprime le fichier s√©lectionn√©
}

/* =========================
   CHART
========================= */
function renderChart(r) {
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(chart, {
        type: "pie",
        data: {
            labels: ["POUR", "POUR (conditions)", "CONTRE", "NEUTRE"],
            datasets: [{ data: [r.pour, r.conditional, r.contre, r.neutre] }]
        }
    });
}

/* =========================
   RESET
========================= */
function resetKeywords() {
    localStora
