<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Analyseur de sondage PDF</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 40px; }
        h1,h2 { text-align:center; }
        .container { max-width:1000px; margin:auto; background:white; padding:30px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.1);}
        .block { margin-bottom:25px; }
        textarea { width:100%; height:90px; padding:10px; }
        button { background:#007bff; color:white; padding:10px 18px; border:none; border-radius:5px; cursor:pointer; margin-right:10px; }
        .results { display:flex; justify-content:space-around; margin-top:30px; }
        .card { background:#f1f3f5; padding:20px; border-radius:8px; width:22%; text-align:center; }
        canvas { max-width:400px; margin:30px auto; display:block; }
    </style>
</head>
<body>

<div class="container">
    <h1>Analyse de sondage ‚Äì Maisons closes</h1>

    <div class="block">
        <h3>1Ô∏è‚É£ Importer le fichier PDF</h3>
        <input type="file" id="pdfInput" accept="application/pdf" />
    </div>

    <div class="block">
        <h3>2Ô∏è‚É£ Mots-cl√©s POUR</h3>
        <textarea id="pourKeywords"></textarea>
    </div>

    <div class="block">
        <h3>3Ô∏è‚É£ Mots-cl√©s POUR SOUS CONDITIONS</h3>
        <textarea id="conditionalKeywords"></textarea>
    </div>

    <div class="block">
        <h3>4Ô∏è‚É£ Mots-cl√©s CONTRE</h3>
        <textarea id="contreKeywords"></textarea>
    </div>

    <div class="block">
        <button onclick="analyze()">üìä Lancer l‚Äôanalyse</button>
        <button onclick="resetKeywords()">üîÑ R√©initialiser</button>
    </div>

    <h2>üë• Personnes analys√©es : <span id="count">0</span></h2>

    <div class="results">
        <div class="card"><h3>‚úÖ POUR</h3><p id="pourResult">0 %</p></div>
        <div class="card"><h3>üü¶ POUR (conditions)</h3><p id="conditionalResult">0 %</p></div>
        <div class="card"><h3>‚ùå CONTRE</h3><p id="contreResult">0 %</p></div>
        <div class="card"><h3>‚öñÔ∏è NEUTRE</h3><p id="neutralResult">0 %</p></div>
    </div>

    <canvas id="chart"></canvas>
</div>

<script>
let keywords = {
    pour: [],
    conditional: ["a condition","sous condition","mais","si"],
    contre: []
};

// Charger le JSON
async function loadKeywords() {
    try {
        const res = await fetch("keywords.json", { cache: "no-store" });
        if(!res.ok) throw new Error("keywords.json introuvable");
        const data = await res.json();
        keywords.pour = Array.isArray(data.pour) ? data.pour : [];
        keywords.conditional = Array.isArray(data.conditional) ? data.conditional : keywords.conditional;
        keywords.contre = Array.isArray(data.contre) ? data.contre : [];
        syncTextareas();
        console.info("keywords.json charg√©");
    } catch(e){
        console.warn("Aucun keywords.json trouv√© ou fichier invalide. Utilisation des mots-cl√©s par d√©faut.");
        syncTextareas();
    }
}

function syncTextareas(){
    document.getElementById("pourKeywords").value = keywords.pour.join("\n");
    document.getElementById("conditionalKeywords").value = keywords.conditional.join("\n");
    document.getElementById("contreKeywords").value = keywords.contre.join("\n");
}

function normalizeText(text){
    return text.normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[‚Äô‚Äò`]/g,"'")
        .replace(/[^\w\s'-]/g,"")
        .toLowerCase();
}

async function extractTextFromPDF(file){
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
    let text = "";
    for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        content.items.forEach(item=>text+=item.str+" ");
    }
    pdf.cleanup(); pdf.destroy();
    return normalizeText(text);
}

function score(text,list){
    let s=0;
    list.forEach(k=>{
        const r = new RegExp(`\\b${normalizeText(k)}\\b`,"g");
        const m = text.match(r);
        if(m) s+= m.length;
    });
    return s;
}

function classify(text){
    const p = score(text,keywords.pour);
    const c = score(text,keywords.conditional);
    const n = score(text,keywords.contre);

    if(n>0 && n>=p) return "contre";
    if(p>0 && c>0) return "conditional";
    if(p>0) return "pour";
    return "neutre";
}

let chartInstance = null;

async function analyze(){
    const file = document.getElementById("pdfInput").files[0];
    if(!file) return alert("S√©lectionne un PDF");

    // r√©cup√©rer les mots-cl√©s depuis les textarea
    keywords.pour = document.getElementById("pourKeywords").value.split("\n").filter(Boolean);
    keywords.conditional = document.getElementById("conditionalKeywords").value.split("\n").filter(Boolean);
    keywords.contre = document.getElementById("contreKeywords").value.split("\n").filter(Boolean);

    const text = await extractTextFromPDF(file);

    // S√©parer tous les votants
    const regex = /([a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,})\s+([\s\S]*?)(?=[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}|$)/gi;
    const opinions = [];
    let match;
    while((match=regex.exec(text))!==null){
        const email = match[1].trim();
        const response = match[2].trim();
        if(email && response) opinions.push(response);
    }

    let r = { pour:0, conditional:0, contre:0, neutre:0 };
    opinions.forEach(o=>{
        if(o.trim().length>10) r[classify(o)]++;
    });

    const total = opinions.length;
    document.getElementById("count").innerText = total;

    document.getElementById("pourResult").innerText = ((r.pour/total)*100).toFixed(1)+" %";
    document.getElementById("conditionalResult").innerText = ((r.conditional/total)*100).toFixed(1)+" %";
    document.getElementById("contreResult").innerText = ((r.contre/total)*100).toFixed(1)+" %";
    document.getElementById("neutralResult").innerText = ((r.neutre/total)*100).toFixed(1)+" %";

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(document.getElementById("chart"),{
        type:"pie",
        data:{
            labels:["POUR","POUR (conditions)","CONTRE","NEUTRE"],
            datasets:[{ data:[r.pour,r.conditional,r.contre,r.neutre], backgroundColor:["#28a745","#007bff","#dc3545","#6c757d"] }]
        }
    });

    document.getElementById("pdfInput").value="";
}

function resetKeywords(){
    location.reload();
}

// üöÄ init
loadKeywords();
</script>

</body>
</html>
